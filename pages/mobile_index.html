
<!doctype html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />

    <!-- For third-generation iPad with high-resolution Retina display: -->
    
    <link rel="icon" href="img/favicons/favicon.ico" type="image/x-icon">
    <title>由我图记</title>
    <link rel="stylesheet" href="http://s5.suc.itc.cn/ux_tudian/asset/mobile/normalize.css" />
    <link rel="stylesheet" href="http://s5.suc.itc.cn/ux_tudian/asset/mobile/foundation.css" />
    <link rel="stylesheet" href="http://s5.suc.itc.cn/ux_tudian/asset/mobile/stamp.css" />
    <link rel="stylesheet" href="http://s5.suc.itc.cn/ux_tudian/asset/mobile/master.css" />
	<script src="http://js.suc.itc.cn/jquery/jquery-1.9.1.js"></script>
	<script src="http://s5.suc.itc.cn/ux_tudian/js/hogan.js"></script>
  </head>
  <body class="antialiased off-canvas hide-extras">
  	<div id="container" class="main">
  		<div class="row">
  			
  			<section id="photo_frame"  class="stamp">
  				<div class="arrow-group">
	  				<a class="pos-abs" href="#"><i class="icon-arrow-left"></i></a>
	  				<a class="pos-abs" href="#"><i class="icon-arrow-right"></i></a>
	  			</div>
          <div class="photos-wrapper">
            <section class="stamp second photo-wrapper" style="display:none;">
              <div><img src="http://s5.suc.itc.cn/ux_tudian/asset/mobile/img_second_bg.jpg" /></div>
              <div class="pos-rel png-box">
                <img class="second-bg" src="http://s5.suc.itc.cn/ux_tudian/asset/mobile/img_second_bg_p1.png" />
                <div class="btn-wrapper"><a href="javascript:;"><img class="img_second_bg" src="http://s5.suc.itc.cn/ux_tudian/asset/mobile/btn_second_bg.png" /></a></div>
                <img class="second-bg" src="http://s5.suc.itc.cn/ux_tudian/asset/mobile/img_second_bg_p2.png" />
              </div>
            </section>

          </div>

  			</section>

  			<section class="stamp first">
					<div><img class="img-first-bg" src="http://s5.suc.itc.cn/ux_tudian/asset/mobile/img_first_bg.png"/></div>
					<div class="pos-rel btn-box">
						<a href="javascript:;"><img src="http://s5.suc.itc.cn/ux_tudian/asset/mobile/btn_first_bg.png"/></a>
  				</div>
  			</section>

  		</div>
  		<script>
  		~function($){
		    $(function(){
		  		var oBtn = $('.first .btn-box a img'),
		  				tBtn = $('.second .png-box a img');

					oBtn.on('mousedown',function() {
						oBtn.attr('src', 'http://s5.suc.itc.cn/ux_tudian/asset/mobile/btn_first_bg_hover.png');
					}).on('mouseup',function() {
						oBtn.attr('src', 'http://s5.suc.itc.cn/ux_tudian/asset/mobile/btn_first_bg.png');
					});
					tBtn.on('mousedown',function() {
						tBtn.attr('src', 'http://s5.suc.itc.cn/ux_tudian/asset/mobile/btn_second_bg_hover.png');
					}).on('mouseup',function() {
						tBtn.attr('src', 'http://s5.suc.itc.cn/ux_tudian/asset/mobile/btn_second_bg.png');
					});

				})
			}(jQuery)
  		</script>
  	</div>
  	<script>
  ~function($){
    $(function(){

      var photo_index = {
        '001': {
          id: '001',
          type: 'root',
          parent_id: '',
          next_id: '',
          prev_id: '',
          top: 0,
          left: 0,
          src: 'http://s5.suc.itc.cn/ux_tudian/asset/mobile/db/001.jpg',
          hotspot: [
            '003',
            '006'
          ]
        },

        '002': {
          id: '002',
          type: 'spot',
          parent_id: '003',
          top: 29,
          left: 24,
          src: 'http://s5.suc.itc.cn/ux_tudian/asset/mobile/db/002.jpg',
          hotspot: [
          ]
        },

        '003': {
          id: '003',
          type: 'spot',
          parent_id: '001',
          top: 50,
          left: 20,
          src: 'http://s5.suc.itc.cn/ux_tudian/asset/mobile/db/003.jpg',
          hotspot: [
            '002'
          ]
        },

        '004': {
          id: '004',
          type: 'root',
          parent_id: '',
          top: 0,
          left: 0,
          src: 'http://s5.suc.itc.cn/ux_tudian/asset/mobile/db/004.jpg',
          hotspot: [
            '005'
          ]
        },

        '005': {
          id: '005',
          type: 'spot',
          parent_id: '004',
          top: 18,
          left: 38,
          src: 'http://s5.suc.itc.cn/ux_tudian/asset/mobile/db/005.jpg',
          hotspot: [
          ]
        },

        '006': {
          id: '006',
          type: 'spot',
          parent_id: '001',
          top: 18,
          left: 38,
          src: 'http://s5.suc.itc.cn/ux_tudian/asset/mobile/db/005.jpg',
          hotspot: [
          ]
        }


      }

      , pages = [
        '001',
        '004'
      ]
      , current_page = 1

      , $photo_frame = $('#photo_frame')

      , rendered = []

      , default_id = '001'

      , template = {

        spot: [
'<img class="hotspot blink" data-action="hotspot_goto" data-spot-id="{{spot_id}}" src="http://s5.suc.itc.cn/ux_tudian/asset/mobile/nil.png" alt="" style="top:{{top}}%;left:{{left}}%;background-image:url({{src}});">'        
        ].join(''),

        photo: [
'<div id="{{dom_id}}" class="photo-wrapper" style="display:none;">',
'<div class="pos-abs pageReference">1 / 2</div>',
'{{#hotspot}}',
'{{>spot}}',
'{{/hotspot}}',
'<div data-action="hotspot_back" data-id="{{id}}" data-parent-id="{{parent_id}}" data-type="{{type}}"><img class="photo" src="{{src}}" alt=""></div>',
'</div>',
        ].join('')

      }

      // 绘制图册
      render(get_photo_data(default_id))

      pagination()

      $photo_frame
      .on('click', '[data-action="hotspot_goto"]', function(event){
        event.preventDefault()

        goto_spot(this)
      })
      .on('click', '[data-action="hotspot_back"]', function(event){
        event.preventDefault()

        back_spot(this)
      })

      function render(data){
        if(rendered.indexOf(data.dom_id) !== -1){
          $photo_frame.find('div.photo-wrapper').hide()

          $('#' + data.dom_id).show().find('img.hotspot:hidden').fadeIn()
        }
        else{
          var html = Hogan.compile(template.photo).render(data, template)
          $photo_frame
          .append(html)
          rendered.push(data.dom_id)
          $photo_frame.find('div.photo-wrapper').hide()
          $('#' + data.dom_id).show().find('img.hotspot:hidden').fadeIn()
        }
      }

      function get_photo_data(id){

        id = id || default_id

        var temp_obj = {}
          , photo_index_obj = photo_index[id]

        if(photo_index_obj){
          temp_obj = Object.create(photo_index_obj)
          temp_obj.dom_id = get_dom_id(temp_obj.id)
          temp_obj.hotspot = []

          photo_index_obj.hotspot.forEach(function(id, i){
            if(typeof photo_index[id] === 'object'){
              temp_obj.hotspot.push({
                spot_id: photo_index[id].id,
                top: photo_index[id].top,
                left: photo_index[id].left,
                src: photo_index[id].src
              })
            }
          })
        }

        return temp_obj;
      }

      function get_dom_id(id){
        return 'spot_' + id || default_id
      }

      function goto_spot(elem){
        var $elem = $(elem)
          , spot_id = $elem.attr('data-spot-id')

        $elem.siblings('img.hotspot').fadeOut()

        //缓存原始高度，96x96 or 60x60
        $elem.data('style_width') || $elem.data('style_width',$elem.css('width'))
        $elem.data('style_height') || $elem.data('style_height',$elem.css('height'))

        $elem
        .addClass('expanding')
        .animate({
          width: '100%',
          height: '100%',
          'border-radius': 0,
          'border-width': 0,
          left: 0,
          top: 0
        }, function(){
          render(get_photo_data(spot_id))
        })
      }

      function back_spot(elem){
        var $elem = $(elem)
          , parent_id = $elem.attr('data-parent-id')
          , parent_dom_id = ''
          , $parent = null
          , type = $elem.attr('data-type')
          , id = $elem.attr('data-id')
          , photo_obj = photo_index[id]

        if(type === 'root'){
          return
        }

        parent_dom_id = get_dom_id(parent_id)
        $parent = $('#' + parent_dom_id)

        render({ dom_id: parent_dom_id })

        

        var $expanded = $parent.find('img.expanding')

        $expanded
        .removeClass('expanding')
        .animate({
          width: $expanded.data('style_width'),
        	height: $expanded.data('style_height'),
          left: photo_obj.left + '%',
          top: photo_obj.top + '%',
          'border-radius': '50%',
          'border-width': '0.2em'
        })

      }

      function photo_reset(){
        rendered.forEach(function(dom_id, i){
          var id = dom_id.substring(dom_id.indexOf('_') + 1)
            , $elem = $('#' + dom_id)

          $elem
          .find('img.hotspot')
          .each(function(i){
            var $spot = $(this)
              , spot_id = $spot.attr('data-spot-id')
              , photo_obj = photo_index[spot_id]
              
            $spot
            .removeClass('expanding')
            .css({
		          width: $expanded.data('style_width'),
        			height: $expanded.data('style_height'),
              left: photo_obj.left + '%',
              top: photo_obj.top + '%',
              borderRadius: '50%',
              borderWidth: '0.2em'
            })
          })
          .show()

        })
      }

      function pagination(){
        var total = pages.length
          , $pagination = $('div.pagination')
          , $current = $pagination.find('span.current')
          , $total = $pagination.find('span.total')

        $current.text(current_page)
        $total.text(total)

        $pagination
        .on('click', 'a.prev', function(event){
          event.preventDefault()
          page_prev()
        })
        .on('click', 'a.next', function(event){
          event.preventDefault()
          page_next()
        })
      }

      function page_next(){
        var total = pages.length
        if(current_page >= total){
          return
        }

        photo_reset()

        var $pagination = $('div.pagination')
          , $current = $pagination.find('span.current')
          , $total = $pagination.find('span.total')

        current_page += 1

        render(get_photo_data(pages[current_page - 1]))

        $current.text(current_page)
      }

      function page_prev(){
        if(current_page <= 1){
          return
        }

        photo_reset()

        var $pagination = $('div.pagination')
          , $current = $pagination.find('span.current')
          , $total = $pagination.find('span.total')

        current_page -= 1

        render(get_photo_data(pages[current_page - 1]))

        $current.text(current_page)

      }

    })
  }(jQuery)
  </script>
  </body>
</html>
